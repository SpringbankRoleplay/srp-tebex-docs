name: Version & Release Manager

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Detect last tag
      # --------------------------------------------------
      - name: Get last tag
        id: last_tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "LAST_TAG=${TAG#v}" >> $GITHUB_ENV
          echo "â¬…ï¸ Laatste versie: ${TAG#v}"

      # --------------------------------------------------
      # Collect commits
      # --------------------------------------------------
      - name: Collect commits
        id: commits
        run: |
          if [ -z "$LAST_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="v$LAST_TAG..HEAD"
          fi

          COMMITS=$(git log $RANGE --pretty=format:"%s")
          COUNT=$(git rev-list --count $RANGE)

          echo "COMMITS_COUNT=$COUNT" >> $GITHUB_ENV
          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "ðŸ”¢ Commits gevonden: $COUNT"

      # --------------------------------------------------
      # Stop if no code changes
      # --------------------------------------------------
      - name: Stop if no commits
        if: env.COMMITS_COUNT == '0'
        run: |
          echo "â­ï¸ Geen nieuwe commits, release wordt overgeslagen"
          exit 0

      # --------------------------------------------------
      # Determine version bump (Conventional Commits)
      # --------------------------------------------------
      - name: Determine version bump
        id: bump
        run: |
          BUMP="patch"

          if echo "$COMMITS" | grep -q "BREAKING CHANGE"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -q "^feat"; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -q "^fix\|^chore"; then
            BUMP="patch"
          else
            echo "â­ï¸ Geen relevante conventional commits gevonden"
            exit 0
          fi

          echo "BUMP=$BUMP" >> $GITHUB_ENV
          echo "ðŸ“ˆ Version bump: $BUMP"

      # --------------------------------------------------
      # Bump version in package.json
      # --------------------------------------------------
      - name: Bump package.json version
        run: |
          npm version $BUMP --no-git-tag-version
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ðŸ“¦ Nieuwe versie: $VERSION"

      # --------------------------------------------------
      # Commit version bump
      # --------------------------------------------------
      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json
          git commit -m "chore(release): v$VERSION"
          git push

      # --------------------------------------------------
      # Create build artifact
      # --------------------------------------------------
      - name: Create release archive
        run: |
          zip -r build-v$VERSION.zip . \
            -x ".git/*" "node_modules/*"

      # --------------------------------------------------
      # Generate grouped changelog
      # --------------------------------------------------
      - name: Generate changelog
        run: |
          FEAT=$(echo "$COMMITS" | grep "^feat" || true)
          FIX=$(echo "$COMMITS" | grep "^fix" || true)
          CHORE=$(echo "$COMMITS" | grep "^chore" || true)

          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "### âœ¨ Features" >> $GITHUB_ENV
          echo "$FEAT" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ðŸ› Fixes" >> $GITHUB_ENV
          echo "$FIX" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "### ðŸ§¹ Chores" >> $GITHUB_ENV
          echo "$CHORE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --------------------------------------------------
      # Create git tag
      # --------------------------------------------------
      - name: Create git tag
        run: |
          git tag "v$VERSION"
          git push origin "v$VERSION"

      # --------------------------------------------------
      # Create GitHub Release
      # --------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: |
            ðŸ“¦ **Versie:** ${{ env.VERSION }}
            ðŸ”¢ **Commits:** ${{ env.COMMITS_COUNT }}

            ${{ env.CHANGELOG }}
          files: |
            build-v${{ env.VERSION }}.zip
